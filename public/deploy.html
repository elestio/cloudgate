<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
    <meta lol="HTML/CSS/JS like if it's 1999!" />
	<title>Atos Remote Deploy</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
    <style>
        .metric{
            width: 150px;
            float: left;
        }

        .logLine{
            margin-top: 6px;
        }
    </style>
</head>

<body>

    <button onclick="PublishProd();" style='background: #0066a1;color: white;padding: 10px;font-weight: bold;'>Deploy to ALIBABA PROD</button>
    <br/>
    <br/>

    <div id='Logs' style='width: 96%; color: back; background: white; padding: 5px; '>

    </div>

     <script>
        
		function connect() {
            var protocolPrefix = (window.location.protocol === 'https:') ? 'wss:' : 'ws:';
            var rootURL = protocolPrefix + '//' + location.host;
            var ws = new WebSocket(rootURL + '/ws');

            //var ws = new WebSocket('ws://vms2.terasp.net/VISITS');
            globalWS = ws;
            ws.onopen = function() {
                var obj = {action: "Watch"};
                Send(JSON.stringify(obj));
                nbConnectRetry = 0;
            };

            ws.onmessage = function(e) {
                
                    var obj = JSON.parse(e.data);
                    if ( obj.action == "Logs" ){
                        var data = obj.message;

                        var newDiv = document.createElement("div");
                        newDiv.innerHTML = "<div class='logLine'>" + data + "</div>";
                        document.getElementById("Logs").appendChild(newDiv);
                        
                        //scroll to page bottom
                        //var objDiv = document.getElementById("Logs");
                        //objDiv.scrollTop = objDiv.scrollHeight;

                        window.scrollTo(0,document.body.scrollHeight);

                    }
                   
                //console.log('Message:', e.data);
            };

            ws.onclose = function(e) {
                console.log('Socket is closed. Reconnect will be attempted in ' + nbConnectRetry + ' seconds.', e.reason);
                setTimeout(function() {
                connect();
                }, 1000*nbConnectRetry); //backoff mechanism
            };

            ws.onerror = function(err) {
                console.error('Socket encountered error: ', err.message, 'Closing socket');
                ws.close();

                nbConnectRetry += 1;
            };
        }

        connect();

		
        function Send(txt) {
            if ( globalWS.readyState != 1 ){
                //websocket is closed, skip it ... (or queue it?)
                return;
            }
            globalWS.send(txt);
        }

        function PublishProd()
        {
            document.getElementById("Logs").innerHTML = '';
            Send( JSON.stringify( {"action": "PublishProd"} ) );
        }

	</script>

</body>

</html>